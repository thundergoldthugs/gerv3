<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>German Word Drills — Minimal Pro</title>
<meta name="theme-color" content="#0f1226" />
<style>
  :root{
    --bg:#0f1226;--surface:#101332;--card:#171a36;--text:#eef1ff;--muted:#b7c0ff;--accent:#6c8cff;
    --good:#19c37d;--bad:#ff5b5b;--stroke:#2b2f63;--pill:#15173a;--shadow:0 18px 38px rgba(0,0,0,.35);
    --bar:#222654;--barFill1:#6c8cff;--barFill2:#9aa8ff;
  }
  :root.light{
    --bg:#f6f8ff;--surface:#f6f8ff;--card:#ffffff;--text:#12142b;--muted:#545f9b;--accent:#4a62ff;
    --good:#18a864;--bad:#e14b4b;--stroke:#dfe3ff;--pill:#eef1ff;--shadow:0 14px 30px rgba(0,0,0,.10);
    --bar:#e9ecff;--barFill1:#5b71ff;--barFill2:#96a3ff;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:radial-gradient(1200px 600px at 80% -10%,#20265b 0%,var(--bg) 60%),
             radial-gradient(900px 700px at -10% 110%,#1a214d 0%,var(--bg) 60%);
    color:var(--text);font:16px/1.35 system-ui,-apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    display:flex;flex-direction:column;min-height:100%;padding:0 env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)
  }

  .topbar{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,0));
    padding:10px 16px 6px;backdrop-filter:saturate(140%) blur(6px)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .sp{justify-content:space-between}
  .chips{display:flex;gap:8px;align-items:center}
  .chip{background:var(--pill);border:1px solid var(--stroke);padding:6px 10px;border-radius:999px;font-weight:700;color:var(--muted)}
  .iconBtn{background:transparent;border:1px solid var(--stroke);color:var(--text);border-radius:12px;padding:10px 12px;cursor:pointer}

  .progress{height:6px;background:var(--bar);border-radius:999px;overflow:hidden;border:1px solid var(--stroke);margin:8px 0 0}
  .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--barFill1),var(--barFill2));width:0%}

  .stage{flex:1;display:flex;align-items:center;justify-content:center;padding:18px}
  .cardWrap{perspective:1600px;width:min(720px,92vw)}
  .card{position:relative;background:var(--card);border:1px solid var(--stroke);border-radius:22px;
    min-height:54vh;display:flex;align-items:center;justify-content:flex-start;flex-direction:column;gap:12px;text-align:center;
    box-shadow:var(--shadow);transform-style:preserve-3d;transition:transform .5s cubic-bezier(.2,.7,.2,1)}
  .card.flipped{transform:rotateY(180deg)}
  .face{position:absolute;inset:0;padding:42px 22px 56px;display:flex;align-items:center;justify-content:flex-start;flex-direction:column;gap:12px;backface-visibility:hidden}
  .back{transform:rotateY(180deg)}
  .langTag{position:absolute;top:14px;left:16px;font-size:12px;color:var(--muted)}
  .word{font-size:clamp(26px, 5.2vw, 42px);font-weight:900;letter-spacing:.2px;padding:0 14px;text-wrap:balance}
  .sub{margin-top:0;color:#c7d0ff}
  :root.light .sub{color:#4f5aa2}

  /* Image banner */
  .imgWrap{
    width:100%;aspect-ratio:16/9;max-height:34vh;overflow:hidden;
    background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(0,0,0,.05));
    border-radius:16px; border:1px solid var(--stroke); position:relative
  }
  .imgWrap img{width:100%;height:100%;object-fit:cover;display:block;filter:saturate(1.05) contrast(1.02)}
  .imgCap{
    position:absolute;right:8px;bottom:8px;background:rgba(0,0,0,.35);
    color:#fff;font-size:11px;padding:4px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.15)
  }
  :root.light .imgCap{background:rgba(255,255,255,.7);color:#222;border-color:rgba(0,0,0,.08)}

  .fab{position:absolute;bottom:14px;right:14px;display:flex;gap:8px}
  .fab .btn{background:var(--surface);border:1px solid var(--stroke);padding:12px 14px;border-radius:14px;cursor:pointer;box-shadow:var(--shadow);font-weight:700}
  .fab .btn.primary{background:var(--accent);color:#fff;border-color:transparent}

  .choices{position:absolute;left:16px;right:16px;bottom:70px;display:grid;grid-template-columns:1fr;gap:8px}
  .choice{padding:14px;border:1px solid var(--stroke);border-radius:12px;background:var(--surface);cursor:pointer}
  .choice.correct{outline:3px solid var(--good)}
  .choice.wrong{outline:3px solid var(--bad)}

  .inlineMeta{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);display:flex;gap:10px;color:var(--muted);font-weight:700}
  .hearts{letter-spacing:2px}
  .hidden{display:none !important}

  .actionbar{position:sticky;bottom:0;z-index:6;background:linear-gradient(0deg, rgba(0,0,0,.35), rgba(0,0,0,0));
    padding:10px 16px 14px;backdrop-filter:saturate(140%) blur(6px)}
  .abtn{flex:1;background:var(--surface);border:1px solid var(--stroke);color:var(--text);padding:14px;border-radius:16px;font-weight:900;cursor:pointer}
  .abtn.good{background:var(--good);border-color:#0ea165;color:#062616}
  .abtn.bad{background:var(--bad);border-color:#d33d3d}
  .abtn.mid{background:var(--surface")}
  .abtn:active{transform:translateY(1px) scale(.99)}

  dialog{border:none;border-radius:18px 18px 0 0;width:100%;max-width:840px;padding:0;background:var(--bg);color:var(--text)}
  dialog::backdrop{background:rgba(0,0,0,.5)}
  .sheetHead{padding:14px 18px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between}
  .sheetBody{padding:14px 18px 22px}
  .section{margin:8px 0 14px}
  .section h4{margin:0 0 8px}
  .rowWrap{display:flex;flex-wrap:wrap;gap:8px}
  select,input[type="number"]{background:var(--surface);border:1px solid var(--stroke);color:var(--text);border-radius:10px;padding:10px 12px;font-weight:700}
  .pillBtn{background:var(--surface);border:1px solid var(--stroke);border-radius:999px;padding:8px 12px;cursor:pointer}
  textarea{width:100%;min-height:160px;background:var(--surface);border:1px solid var(--stroke);border-radius:12px;color:var(--text);
    padding:12px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}

  .heat{display:grid;grid-template-columns:repeat(42,1fr);gap:2px}
  .heat div{width:10px;height:10px;border-radius:2px;background:#13173b;border:1px solid var(--stroke)}
  :root.light .heat div{background:#ecedff}
  .h1{background:#6776ff !important}.h2{background:#5263f5 !important}.h3{background:#3e52ea !important}.h4{background:#2b40da !important}

  /* Examples drawer */
  .exDrawer{position:fixed;left:50%;bottom:92px;transform:translateX(-50%);width:min(720px,92vw);max-height:40vh;overflow:auto;background:var(--surface);border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);padding:10px 12px;z-index:8}
  .exItem{padding:8px 6px;border-bottom:1px dashed var(--stroke")} .exItem:last-child{border-bottom:none}
  .src{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="topbar">
    <div class="row sp">
      <div class="chips">
        <span class="chip" id="chipStreak">Streak 0</span>
        <span class="chip" id="chipDaily">0/30</span>
      </div>
      <div class="row">
        <button id="openSheet" class="iconBtn" title="Settings & more">☰</button>
        <button id="themeBtn" class="iconBtn" title="Theme">🌓</button>
      </div>
    </div>
    <div class="progress"><span id="progressBar"></span></div>
  </div>

  <main class="stage">
    <div class="cardWrap">
      <div class="card" id="card">
        <div class="face front">
          <div class="langTag" id="frontTag">German</div>

          <!-- image banner (front only) -->
          <div id="imgWrap" class="imgWrap hidden">
            <img id="cardImg" alt="" />
            <div id="imgCap" class="imgCap"></div>
          </div>

          <div>
            <div class="word" id="frontWord">–</div>
            <div class="sub" id="frontHint"></div>
          </div>
          <div id="mcArea" class="choices hidden"></div>
          <div class="inlineMeta">
            <div id="hearts" class="hearts hidden">♥♥♥</div>
            <div id="timer" class="hidden">60s</div>
          </div>
          <div class="fab">
            <button id="examplesBtn" class="btn" title="Examples">🔎</button>
            <button id="speakFront" class="btn" title="Play">🔊</button>
          </div>
        </div>

        <div class="face back">
          <div class="langTag" id="backTag">English</div>
          <div>
            <div class="word" id="backWord">–</div>
            <div class="sub" id="backHint"></div>
          </div>
          <div class="fab">
            <button id="speakBack" class="btn" title="Play">🔊</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="actionbar">
    <div class="row">
      <button id="againBtn" class="abtn bad">Again</button>
      <button id="flipBtn" class="abtn mid">Flip</button>
      <button id="goodBtn" class="abtn good">Got it</button>
    </div>
  </div>

  <!-- Bottom Sheet -->
  <dialog id="sheet">
    <div class="sheetHead">
      <strong>Controls & Stats</strong>
      <div class="row">
        <button id="toggleImages" class="pillBtn">Images: On</button>
        <button id="audioToggle" class="pillBtn">Audio: Off</button>
        <button id="closeSheet" class="pillBtn">Close</button>
      </div>
    </div>
    <div class="sheetBody">
      <div class="section">
        <h4>Quick Controls</h4>
        <div class="rowWrap">
          <select id="mode">
            <option value="de-en">German → English (Flip)</option>
            <option value="en-de">English → German (Flip)</option>
            <option value="mix">Mix (Flip)</option>
            <option value="mc">Multiple Choice</option>
            <option value="time">Time Attack (60s)</option>
          </select>
          <select id="tagFilter"><option value="">All tags</option></select>
          <button id="newRoundBtn" class="pillBtn">New round</button>
          <button id="repeatBtn" class="pillBtn">Repeat</button>
          <button id="resetBtn" class="pillBtn" style="color:#e14b4b">Reset</button>
        </div>
      </div>

      <div class="section">
        <h4>Daily Goal</h4>
        <div class="rowWrap">
          <input id="dailyGoalInput" type="number" min="5" max="200" step="5" />
          <span class="chip" id="chipRound">Round 1</span>
          <span class="chip" id="chipScore">Score 0</span>
        </div>
      </div>

      <div class="section">
        <h4>Achievements</h4>
        <div class="rowWrap">
          <span class="chip" id="badge100">🥇 100 Correct</span>
          <span class="chip" id="badge500">🏆 500 Correct</span>
          <span class="chip" id="badgeStreak5">🔥 5-Day Streak</span>
          <span class="chip" id="badgePerfect">💯 Perfect Round</span>
          <span class="chip" id="badgeTime">⏱️ Speedster</span>
        </div>
      </div>

      <div class="section">
        <h4>Activity (6 weeks)</h4>
        <div id="heat" class="heat"></div>
      </div>

      <div class="section">
        <h4>Import / Export</h4>
        <p class="sub" style="margin:0 0 6px">Paste lines like <code>Haus - house #home</code> or tab-separated. Add multiple <code>#tags</code> if you want.</p>
        <textarea id="importText" placeholder="Haus - house #home
gehen : to go
der Tisch, the table #furniture"></textarea>
        <div class="rowWrap" style="margin-top:8px">
          <label><input type="checkbox" id="swapOnImport"> English first (swap)</label>
          <button id="appendSample" class="pillBtn">Add sample 10</button>
          <button id="importBtn" class="pillBtn">Import</button>
          <button id="exportTSV" class="pillBtn">Export TSV</button>
          <button id="exportJSON" class="pillBtn">Export JSON</button>
          <button id="importJSON" class="pillBtn">Import JSON</button>
          <input type="file" id="jsonFile" accept="application/json" class="hidden"/>
        </div>
      </div>

      <div class="section">
        <h4>Sources & Attribution</h4>
        <p class="sub" style="margin:0">
          Images via Openverse & Wikimedia Commons (licensed/open). We show per-image credit & license.<br/>
          Examples (if you add <code>data/examples.json</code>) are local to this site.
        </p>
      </div>
    </div>
  </dialog>

<script>
/* ===== storage keys ===== */
const LS_KEY="german_flashcards_deck_v2";
const LS_STATS="german_flashcards_stats_v2";
const LS_THEME="german_flashcards_theme";
const LS_AUDIO="german_flashcards_audio_autoplay";
const LS_IMAGES="german_flashcards_images_on";
const LS_IMG_CACHE="german_flashcards_img_cache_v1";
const EX_LS_KEY="german_examples_json_v1";

/* ===== helpers ===== */
const now=()=>Date.now(); const todayISO=()=>new Date().toISOString().slice(0,10);
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function sample(arr,n){const c=[...arr];shuffle(c);return c.slice(0,n)}

/* ===== deck & stats ===== */
function loadDeck(){try{const raw=localStorage.getItem(LS_KEY);if(!raw)return[];const arr=JSON.parse(raw);return Array.isArray(arr)?arr.filter(v=>v&&v.de&&v.en):[]}catch(e){return[]}}
function saveDeck(d){localStorage.setItem(LS_KEY,JSON.stringify(d))}
function defaultStats(){return{score:0,streak:0,round:1,correctTotal:0,dailyGoal:30,dailyCount:0,lastStudyDate:todayISO(),dayStreak:0,achievements:{a100:false,a500:false,streak5:false,perfect:false,time30:false},heat:{}}}
function loadStats(){try{const s=JSON.parse(localStorage.getItem(LS_STATS)||"null");return s?s:defaultStats()}catch(e){return defaultStats()}}
function saveStats(){localStorage.setItem(LS_STATS,JSON.stringify(stats))}

let deck=loadDeck(), stats=loadStats();
/* migrate v1 if exists */
(function(){const old=localStorage.getItem("german_flashcards_deck_v1");if(old && deck.length===0){try{const prev=JSON.parse(old);deck=prev.map(d=>({...d,box:1,dueAt:0,tags:[]}));saveDeck(deck)}catch(e){}}})();
/* seed */
if(deck.length===0){deck=[{de:"Haus",en:"house",box:1,dueAt:0,tags:["basic"]},{de:"gehen",en:"to go",box:1,dueAt:0,tags:["verbs"]},{de:"der Tisch",en:"the table",box:1,dueAt:0,tags:["home"]},{de:"schön",en:"beautiful",box:1,dueAt:0,tags:["adjectives"]},{de:"lernen",en:"to learn",box:1,dueAt:0,tags:["verbs"]},{de:"Buch",en:"book",box:1,dueAt:0,tags:["basic"]},{de:"sprechen",en:"to speak",box:1,dueAt:0,tags:["verbs"]},{de:"Freund",en:"friend",box:1,dueAt:0,tags:["people"]},{de:"Essen",en:"food",box:1,dueAt:0,tags:["food"]},{de:"trinken",en:"to drink",box:1,dueAt:0,tags:["verbs"]}];saveDeck(deck)}

/* ===== SRS ===== */
const INTERVALS={1:0,2:60*60*1000,3:24*60*60*1000,4:3*24*60*60*1000,5:7*24*60*60*1000,6:30*24*60*1000};
let activeTag="";function isDue(p){const tagOk=!activeTag||(p.tags||[]).includes(activeTag);return tagOk && (p.dueAt||0)<=now()}
function schedule(p,ok){p.box=ok?Math.min((p.box||1)+1,6):1;p.dueAt=now()+(INTERVALS[p.box]||0)}

/* ===== session ===== */
let queue=[],missed=new Set(),pos=0,showingBack=false,mixDir=[];
let hearts=3,timeLeft=60,timerId=null;
let autoAudio=localStorage.getItem(LS_AUDIO)==="on";
let imagesOn=(localStorage.getItem(LS_IMAGES) ?? "on")==="on";
let IMG_CACHE={}; try{IMG_CACHE=JSON.parse(localStorage.getItem(LS_IMG_CACHE)||"{}")}catch(e){IMG_CACHE={};}

/* NEW: track per-round lapses for better “Again” spacing */
let lapses = new Map();

/* ===== UI refs ===== */
const progressBar=document.getElementById('progressBar');
const cardEl=document.getElementById('card');
const frontWord=document.getElementById('frontWord');
const backWord=document.getElementById('backWord');
const frontTag=document.getElementById('frontTag');
const backTag=document.getElementById('backTag');
const frontHint=document.getElementById('frontHint');
const backHint=document.getElementById('backHint');
const mcArea=document.getElementById('mcArea');
const heartsEl=document.getElementById('hearts');
const timerEl=document.getElementById('timer');
const imgWrap=document.getElementById('imgWrap');
const cardImg=document.getElementById('cardImg');
const imgCap=document.getElementById('imgCap');

const chipStreak=document.getElementById('chipStreak');
const chipDaily=document.getElementById('chipDaily');
const chipRound=document.getElementById('chipRound');
const chipScore=document.getElementById('chipScore');

const openSheetBtn=document.getElementById('openSheet');
const closeSheetBtn=document.getElementById('closeSheet');
const sheet=document.getElementById('sheet');

const modeSel=document.getElementById('mode');
const tagSel=document.getElementById('tagFilter');
const newRoundBtn=document.getElementById('newRoundBtn');
const repeatBtn=document.getElementById('repeatBtn');
const dailyGoalInput=document.getElementById('dailyGoalInput');

const badge100=document.getElementById('badge100');
const badge500=document.getElementById('badge500');
const badgeStreak5=document.getElementById('badgeStreak5');
const badgePerfect=document.getElementById('badgePerfect');
const badgeTime=document.getElementById('badgeTime');
const heatEl=document.getElementById('heat');
const audioToggle=document.getElementById('audioToggle');
const toggleImages=document.getElementById('toggleImages');

/* ===== import / export wiring ===== */
const importText = document.getElementById('importText');
const importBtn = document.getElementById('importBtn');
const appendSampleBtn = document.getElementById('appendSample');
const exportTSVBtn = document.getElementById('exportTSV');
const exportJSONBtn = document.getElementById('exportJSON');
const importJSONBtn = document.getElementById('importJSON');
const jsonFile = document.getElementById('jsonFile');
const swapOnImport = document.getElementById('swapOnImport');

function parseLinesToPairs(text, { swap=false } = {}) {
  const out = [];
  const lines = (text || '').split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  for (const raw of lines) {
    // accept: "Haus - house #home", "gehen : to go", "der Tisch, the table #furniture", "Buch\tbook\t#basic"
    const parts = raw.split(/\t| - | : |, /);
    if (parts.length < 2) continue;
    let left = parts[0].trim();
    let right = parts[1].trim();
    // tags anywhere in the line
    const tags = Array.from(raw.matchAll(/#([\p{L}\p{N}_-]+)/gu)).map(m => m[1]);
    const de = swap ? right : left;
    const en = swap ? left : right;
    if (!de || !en) continue;
    out.push({ de, en, box:1, dueAt:0, tags: tags.length? tags : [] });
  }
  return out;
}

function mergeIntoDeck(newPairs) {
  // avoid dupes (by normalized de+en)
  const sig = (p) => `${p.de}||${p.en}`.toLowerCase().trim();
  const seen = new Set(deck.map(sig));
  const toAdd = [];
  for (const p of newPairs) {
    if (!seen.has(sig(p))) { toAdd.push(p); seen.add(sig(p)); }
  }
  if (toAdd.length) {
    deck = deck.concat(toAdd);
    saveDeck(deck);
    refreshTagSelect();
  }
  return toAdd.length;
}

appendSampleBtn.onclick = () => {
  const sample = [
    "die Katze - the cat #animals",
    "die Stadt - the city #places",
    "schwierig - difficult #adjectives",
    "das Wasser - water #food",
    "schnell - fast #adjectives",
    "der Stuhl - the chair #home",
    "die Frage - the question #basic",
    "antworten - to answer #verbs",
    "denken - to think #verbs",
    "das Wetter - weather #nature"
  ].join("\n");
  importText.value = (importText.value ? importText.value + "\n" : "") + sample;
};

importBtn.onclick = () => {
  const swap = !!swapOnImport.checked;
  const pairs = parseLinesToPairs(importText.value, { swap });
  const added = mergeIntoDeck(pairs);
  if (added === 0) {
    alert("No new cards parsed (maybe duplicates or format issues).");
  } else {
    alert(`Imported ${added} cards.`);
  }
  buildRound({ shuffleQ:true });
};

exportTSVBtn.onclick = () => {
  const tsv = deck.map(d => [d.de, d.en, (d.tags||[]).map(t=>`#${t}`).join(" ")].join("\t")).join("\n");
  const blob = new Blob([tsv], { type:'text/tab-separated-values;charset=utf-8' });
  const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'german_deck.tsv' });
  document.body.appendChild(a); a.click(); a.remove();
};

exportJSONBtn.onclick = () => {
  const blob = new Blob([JSON.stringify(deck, null, 2)], { type:'application/json;charset=utf-8' });
  const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'german_deck.json' });
  document.body.appendChild(a); a.click(); a.remove();
};

importJSONBtn.onclick = () => jsonFile.click();
jsonFile.onchange = async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    const arr = JSON.parse(text);
    const cleaned = Array.isArray(arr) ? arr.filter(v => v && v.de && v.en).map(v => ({
      de: String(v.de), en: String(v.en),
      box: Number(v.box)||1, dueAt: 0, // reset schedule on import
      tags: Array.isArray(v.tags) ? v.tags : []
    })) : [];
    const added = mergeIntoDeck(cleaned);
    alert(`Imported ${added} new cards.`);
    buildRound({ shuffleQ:true });
  } catch (err) {
    alert('Failed to import JSON: ' + (err?.message||err));
  } finally {
    jsonFile.value = '';
  }
};

/* ===== build rounds ===== */
function buildRound({shuffleQ=true,fromMissed=false}={}){
  clearTimer();
  const idxAll=deck.map((_,i)=>i);
  const due=idxAll.filter(i=>isDue(deck[i]));
  const news=idxAll.filter(i=>(deck[i].dueAt||0)===0).filter(i=>!activeTag||(deck[i].tags||[]).includes(activeTag));
  let base=fromMissed?Array.from(missed):[...due,...news];
  if(base.length===0){base=idxAll.filter(i=>!activeTag||(deck[i].tags||[]).includes(activeTag))}
  base=Array.from(new Set(base));
  queue=shuffleQ?shuffle([...base]):[...base];
  mixDir=queue.map(()=>Math.random()<0.5?"de-en":"en-de");
  pos=0;missed.clear();showingBack=false;

  /* NEW: reset per-round lapse counters */
  lapses.clear();

  updateProgress();renderCard();updateHeader();applyControlsForMode()
}

/* ===== header & stats ===== */
function updateHeader(){
  chipStreak.textContent=`Streak ${stats.streak}`;
  chipDaily.textContent=`${stats.dailyCount}/${stats.dailyGoal}`;
  chipRound.textContent=`Round ${stats.round}`;
  chipScore.textContent=`Score ${stats.score}`;
  const dim=(el,on)=>el.style.opacity=on?1:.45;
  dim(badge100,stats.achievements.a100);
  dim(badge500,stats.achievements.a500);
  dim(badgeStreak5,stats.achievements.streak5);
  dim(badgePerfect,stats.achievements.perfect);
  dim(badgeTime,stats.achievements.time30);
  dailyGoalInput.value = stats.dailyGoal;
  audioToggle.textContent = `Audio: ${autoAudio?'On':'Off'}`;
  toggleImages.textContent = `Images: ${imagesOn?'On':'Off'}`;
}
function tickDaily(date=todayISO()){
  if(stats.lastStudyDate!==date){
    const y=new Date(date);y.setDate(y.getDate()-1);const yISO=y.toISOString().slice(0,10);
    const hit=(stats.heat[yISO]||0)>=stats.dailyGoal;
    stats.dayStreak=hit?(stats.dayStreak+1):0;
    stats.dailyCount=0;stats.lastStudyDate=date;saveStats();
  }
}

/* ===== render card ===== */
function current(){if(queue.length===0)return null;const idx=queue[Math.min(pos,queue.length-1)];const pair=deck[idx];let dir=modeSel.value==="mix"?mixDir[pos]:modeSel.value;return{idx,pair,dir}}
function renderCard(){
  if(deck.length===0){frontWord.textContent="Add words in the sheet →";backWord.textContent="";imgWrap.classList.add('hidden');return}
  const cur=current(); if(!cur) return; const {pair,dir}=cur;

  if(dir==="mc"||dir==="time"){
    cardEl.classList.remove('flipped');showingBack=false;
    frontTag.textContent="Pick the correct meaning";backTag.textContent="";
    frontWord.textContent=pair.de;backWord.textContent="";
    buildChoices(pair);
    if(dir==="time"){startTimer();hearts=3;heartsEl.textContent="♥".repeat(hearts);heartsEl.classList.remove('hidden');timerEl.classList.remove('hidden')}
    else{clearTimer();heartsEl.classList.add('hidden');timerEl.classList.add('hidden')}
    if(autoAudio) speak(pair.de,'de');
    renderImage(pair.en);
  }else{
    const showFront=dir==="de-en"?pair.de:pair.en;
    const showBack=dir==="de-en"?pair.en:pair.de;
    frontWord.textContent=showFront;backWord.textContent=showBack;
    frontTag.textContent=dir==="de-en"?"German":"English";
    backTag.textContent=dir==="de-en"?"English":"German";
    clearTimer();heartsEl.classList.add('hidden');timerEl.classList.add('hidden');
    if(autoAudio){const lang=dir==="de-en"?'de':'en';speak(showFront,lang)}
    renderImage(pair.en);
  }
  frontHint.textContent=(pair.tags&&pair.tags.length)?`#${pair.tags.join(" #")}`:"";
  backHint.textContent="";
  renderHeat();refreshTagSelect();
}

/* ===== image search & cache ===== */
function normTerm(s){
  return (s||"")
    .toLowerCase()
    .replace(/^(to\s+|the\s+|a\s+|an\s+)/,'') // better search terms
    .trim();
}

// Openverse (no key): https://api.openverse.org/v1/images/?q=
async function searchOpenverse(term){
  const url = `https://api.openverse.org/v1/images/?q=${encodeURIComponent(term)}&page_size=1`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('ov fail');
  const j = await r.json();
  const item = j.results && j.results[0];
  if(!item) throw new Error('ov none');
  return {
    thumb: item.thumbnail || item.url,
    creator: item.creator || (item.source ? item.source : "Openverse"),
    license: item.license ? (item.license_version ? `${item.license} ${item.license_version}` : item.license) : "Open",
    link: item.foreign_landing_url || item.url,
    via: "Openverse"
  };
}

// Wikimedia Commons: add origin=* and namespace=6 (files)
async function searchCommons(term){
  const url =
    `https://commons.wikimedia.org/w/api.php`+
    `?action=query&format=json&origin=*`+
    `&generator=search&gsrsearch=${encodeURIComponent(term)}`+
    `&gsrlimit=1&gsrnamespace=6&gsrenablerewrites=1`+
    `&prop=imageinfo&iiprop=url|extmetadata&iiurlwidth=640`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('wm fail');
  const j = await r.json();
  const pages = j.query && j.query.pages;
  if(!pages) throw new Error('wm none');
  const first = pages[Object.keys(pages)[0]];
  const info = first && first.imageinfo && first.imageinfo[0];
  if(!info) throw new Error('wm noimg');
  const licenseShort =
    (info.extmetadata && info.extmetadata.LicenseShortName && info.extmetadata.LicenseShortName.value) || "Commons";
  return {
    thumb: info.thumburl || info.url,
    creator: "Wikimedia Commons",
    license: licenseShort,
    link: `https://commons.wikimedia.org/?curid=${first.pageid}`,
    via: "Commons"
  };
}

function withTimeout(promise, ms=1800){
  let to; return Promise.race([
    promise,
    new Promise((_,rej)=>{ to=setTimeout(()=>rej(new Error('timeout')),ms); })
  ]).finally(()=>clearTimeout(to));
}

async function fetchImage(english){
  const key = normTerm(english);
  if(IMG_CACHE[key]) return IMG_CACHE[key];

  let data=null;
  try { data = await withTimeout(searchOpenverse(key)); }
  catch(e){ try { data = await withTimeout(searchCommons(key)); } catch(e2){ data=null; } }

  if(data){
    IMG_CACHE[key]=data;
    try{ localStorage.setItem(LS_IMG_CACHE, JSON.stringify(IMG_CACHE)); }catch(e){}
  }
  return data;
}

async function renderImage(english){
  if(!imagesOn){ imgWrap.classList.add('hidden'); return; }
  const data = await fetchImage(english);
  if(!data || !data.thumb){ imgWrap.classList.add('hidden'); return; }
  cardImg.src = data.thumb;
  imgCap.textContent = data.creator ? `${data.creator} — ${data.license} • ${data.via}` : data.via;
  imgWrap.classList.remove('hidden');
}

/* ===== choices (MC) ===== */
function buildChoices(pair){
  const wrong = deck.filter(d => d.en !== pair.en && (!activeTag || (d.tags||[]).includes(activeTag)));
  const choices = shuffle([pair.en, ...sample(wrong.map(d=>d.en), Math.min(3, Math.max(0, wrong.length)))]);
  mcArea.innerHTML = ""; mcArea.classList.remove('hidden');
  choices.forEach(ch => {
    const div = document.createElement('button');
    div.className = 'choice';
    div.type = 'button';
    div.setAttribute('role','button');
    div.setAttribute('aria-pressed','false');
    div.textContent = ch;
    div.onclick = () => {
      if (ch === pair.en) {
        div.classList.add('correct');
        div.setAttribute('aria-pressed','true');
        markGood(true);
      } else {
        div.classList.add('wrong');
        div.setAttribute('aria-pressed','true');
        hearts = Math.max(0, hearts - 1);
        heartsEl.textContent = "♥".repeat(hearts);
        markAgain(true);
        if (hearts === 0 && modeSel.value === 'time') { clearTimer(); endRound(); return; }
      }
      setTimeout(()=>next(), 280);
    };
    mcArea.appendChild(div);
  });
}

/* ===== progress & nav ===== */
function updateProgress(){const done=queue.length===0?0:(pos/queue.length)*100;progressBar.style.width=`${done}%`}
function next(){if(queue.length===0)return;pos=Math.min(pos+1,queue.length);showingBack=false;if(pos>=queue.length){endRound()}else{renderCard();updateProgress()}}
function prev(){if(pos<=0)return;pos-=1;showingBack=false;renderCard();updateProgress()}
function flip(){if(modeSel.value==="mc"||modeSel.value==="time")return;showingBack=!showingBack;cardEl.classList.toggle('flipped',showingBack)}

/* ===== marking ===== */
function bump(correct){
  stats.streak=correct?stats.streak+1:0;
  stats.score+=correct?(10+Math.min(30,stats.streak)):0;
  if(correct) stats.correctTotal+=1;
  tickDaily(); stats.dailyCount+=1; const day=todayISO(); stats.heat[day]=(stats.heat[day]||0)+1;
  if(stats.correctTotal>=100) stats.achievements.a100=true;
  if(stats.correctTotal>=500) stats.achievements.a500=true;
  if(stats.dayStreak>=5) stats.achievements.streak5=true;
  saveStats(); updateHeader();
}
function markGood(){const cur=current();if(!cur)return;const {idx,pair}=cur;schedule(pair,true);deck[idx]=pair;saveDeck(deck);bump(true)}

/* ===== UPDATED “Again” spacing ===== */
function markAgain(inMc=false){
  const cur = current(); if (!cur) return;
  const { idx, pair } = cur;

  // Reset box and due time for inter-round SRS
  schedule(pair, false);
  deck[idx] = pair;
  saveDeck(deck);

  // stats bump (wrong)
  bump(false);

  // Track how many times this card has been missed in the current round
  const count = (lapses.get(idx) || 0) + 1;
  lapses.set(idx, count);

  // Ensure there isn't another copy of this card later in the queue
  for (let i = queue.length - 1; i > pos; i--) {
    if (queue[i] === idx) queue.splice(i, 1);
  }

  // Determine spacing based on misses and remaining items
  const remaining = Math.max(0, queue.length - pos - 1);
  let frac = 0.3;           // 1st lapse → ~30% of remaining
  if (count === 2) frac = 0.6;    // 2nd lapse → ~60%
  else if (count >= 3) frac = 0.9; // 3rd+ lapse → ~90%

  // Convert to a gap with a sensible minimum so it won't loop too soon
  let gap = Math.max(5, Math.round(remaining * frac));
  const ins = Math.min(queue.length, pos + 1 + gap);

  // Reinsert once, farther away
  queue.splice(ins, 0, idx);

  // Track for end-of-round stats/badges
  missed.add(idx);

  // (In MC/time modes, caller already advances with next(); in flip modes, the button handlers call next() after this.)
}

/* ===== end round ===== */
function endRound(){
  stats.achievements.perfect = stats.achievements.perfect || (missed.size===0 && queue.length>0); saveStats();
  stats.round += 1; saveStats(); updateHeader();
  const t=document.createElement('div');
  t.textContent=`Round complete — missed ${missed.size}`;
  Object.assign(t.style,{position:'fixed',left:'50%',bottom:'84px',transform:'translateX(-50%)',background:'var(--surface)',border:'1px solid var(--stroke)',padding:'10px 14px',borderRadius:'12px',boxShadow:'var(--shadow)',zIndex:9});
  document.body.appendChild(t); setTimeout(()=>t.remove(),1600);
  progressBar.style.width='100%';
}

/* ===== heatmap & tags ===== */
function renderHeat(){
  heatEl.innerHTML="";
  const today=new Date();
  for(let i=41;i>=0;i--){
    const d=new Date(today); d.setDate(today.getDate()-i);
    const key=d.toISOString().slice(0,10); const count=stats.heat[key]||0;
    const box=document.createElement('div'); let cls="";
    if(count>=1 && count<stats.dailyGoal*0.25) cls="h1";
    else if(count<stats.dailyGoal*0.5 && count>0) cls="h2";
    else if(count<stats.dailyGoal && count>0) cls="h3";
    else if(count>=stats.dailyGoal) cls="h4";
    if(cls) box.classList.add(cls);
    heatEl.appendChild(box);
  }
}
function allTags(){const s=new Set();deck.forEach(d=>(d.tags||[]).forEach(t=>s.add(t)));return Array.from(s).sort()}
function refreshTagSelect(){
  const tags=allTags();
  if(tagSel.options.length-1 !== tags.length){
    const cur=tagSel.value;
    tagSel.innerHTML=`<option value="">All tags</option>` + tags.map(t=>`<option value="${t}">#${t}</option>`).join("");
    tagSel.value=cur||"";
  }
}

/* ===== theme ===== */
function applyTheme(){
  const pref=localStorage.getItem(LS_THEME); const root=document.documentElement;
  if(pref==="light"){root.classList.add('light');document.querySelector('meta[name="theme-color"]').setAttribute('content','#ffffff')}
  else if(pref==="dark"){root.classList.remove('light');document.querySelector('meta[name="theme-color"]').setAttribute('content','#0f1226')}
  else{const light=window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches; if(light) root.classList.add('light'); else root.classList.remove('light')}
}
document.getElementById('themeBtn').onclick=()=>{const cur=localStorage.getItem(LS_THEME);const next=cur==="light"?"dark":(cur==="dark"?"":"light"); if(next==="")localStorage.removeItem(LS_THEME);else localStorage.setItem(LS_THEME,next); applyTheme()}

/* ===== timer ===== */
function startTimer(){clearTimer();timeLeft=60;timerEl.textContent=`${timeLeft}s`;timerId=setInterval(()=>{timeLeft-=1;timerEl.textContent=`${timeLeft}s`;if(timeLeft<=0){clearTimer();endRound()}},1000)}
function clearTimer(){if(timerId){clearInterval(timerId);timerId=null}}

/* ===== audio (TTS) ===== */
let voices=[];
function loadVoices(){voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : []; if(window.speechSynthesis && voices.length===0){window.speechSynthesis.onvoiceschanged=()=>{voices=window.speechSynthesis.getVoices()}}}
function pickVoice(hint){if(!voices||voices.length===0)return null;const prefs = hint==='de'?['de-DE','de-AT','de-CH']:['en-US','en-GB','en-CA','en-AU'];for(const l of prefs){const v=voices.find(v=>v.lang===l);if(v) return v}const v2=voices.find(v=>v.lang && v.lang.toLowerCase().startsWith(hint));return v2||voices[0]||null}
function speak(text,langHint='de'){try{if(!('speechSynthesis'in window))return;window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(text);const v=pickVoice(langHint);if(v)u.voice=v;u.lang=v?.lang||(langHint==='de'?'de-DE':'en-US');u.rate=langHint==='de'?0.95:1.0;window.speechSynthesis.speak(u)}catch(e){}}
document.getElementById('speakFront').onclick=()=>{const cur=current();if(!cur)return;const {pair,dir}=cur;if(dir==='mc'||dir==='time'){speak(pair.de,'de');return}const text=dir==='de-en'?pair.de:pair.en; const lang=dir==='de-en'?'de':'en';speak(text,lang)}
document.getElementById('speakBack').onclick=()=>{const cur=current();if(!cur)return;const {pair,dir}=cur;if(dir==='mc'||dir==='time'){speak(pair.en,'en');return}const text=dir==='de-en'?pair.en:pair.de; const lang=dir==='de-en'?'en':'de';speak(text,lang)}
audioToggle.onclick=()=>{autoAudio=!autoAudio;localStorage.setItem(LS_AUDIO,autoAudio?'on':'off');updateHeader()}
toggleImages.onclick=()=>{imagesOn=!imagesOn;localStorage.setItem(LS_IMAGES,imagesOn?'on':'off');updateHeader();renderCard();}

/* ===== bottom sheet & controls ===== */
openSheetBtn.onclick=()=>sheet.showModal();
closeSheetBtn.onclick=()=>sheet.close();
function applyControlsForMode(){
  const flipBtn=document.getElementById('flipBtn');
  const isMC=modeSel.value==="mc"||modeSel.value==="time";
  flipBtn.textContent = isMC ? "Skip" : "Flip";
  mcArea.classList.toggle('hidden', !isMC);
  if(modeSel.value==="time"){hearts=3;heartsEl.textContent="♥".repeat(hearts)}
}
modeSel.onchange=()=>{applyControlsForMode();renderCard()};
tagSel.onchange=(e)=>{activeTag=e.target.value;buildRound({shuffleQ:true})};
newRoundBtn.onclick=()=>buildRound({shuffleQ:true});
repeatBtn.onclick = ()=>buildRound({shuffleQ:true,fromMissed:false});
document.getElementById('resetBtn').onclick=()=>{
  if(!confirm("Clear ALL words & stats?")) return;
  localStorage.removeItem(LS_KEY); localStorage.removeItem(LS_STATS);
  deck=[]; stats=defaultStats(); saveStats(); saveDeck(deck);
  buildRound({shuffleQ:true});
};
document.getElementById('againBtn').onclick = ()=>{ const isMC=(modeSel.value==="mc"||modeSel.value==="time"); if(isMC){ markAgain(true); next(); } else { markAgain(); next(); } };
document.getElementById('goodBtn').onclick  = ()=>{ const isMC=(modeSel.value==="mc"||modeSel.value==="time"); if(isMC){ markGood(true); next(); } else { markGood(); next(); } };
document.getElementById('flipBtn').onclick  = ()=>{ const isMC=(modeSel.value==="mc"||modeSel.value==="time"); if(isMC){ next(); } else { flip(); } };

/* ===== keyboard shortcuts =====
   Space = Flip/Skip, Left = Again, Right = Got it */
window.addEventListener('keydown', (e) => {
  if (e.target && /input|textarea|select/i.test(e.target.tagName)) return;
  if (e.key === ' ') { e.preventDefault(); document.getElementById('flipBtn').click(); }
  else if (e.key === 'ArrowLeft') { document.getElementById('againBtn').click(); }
  else if (e.key === 'ArrowRight') { document.getElementById('goodBtn').click(); }
});

/* ===== examples (optional local JSON) ===== */
let EX_CACHE=null, EX_LOADED=false;
async function loadExamples(){ if(EX_CACHE) return EX_CACHE;
  try{const cached=localStorage.getItem(EX_LS_KEY); if(cached){EX_CACHE=JSON.parse(cached); EX_LOADED=true; return EX_CACHE;} }catch(e){}
  try{
    // relative path so it works on GitHub project pages
    const base = (document.querySelector('base')?.href) || (location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^/]+$/,''));
    const res = await fetch(`${base}data/examples.json`, { cache:'no-cache' });
    if(!res.ok) throw 0; EX_CACHE=await res.json(); EX_LOADED=true;
    try{localStorage.setItem(EX_LS_KEY,JSON.stringify(EX_CACHE))}catch(e){}
    return EX_CACHE;
  } catch(e){EX_CACHE={};EX_LOADED=false;return EX_CACHE;}
}
function normKey(s){return (s||"").toLowerCase().replace(/^[\s]*(der|die|das|ein|eine|einen|einem|einer)\s+/,'').replace(/[().,!?;:"'«»„”“]/g,'').trim()}
async function findExamplesFor(text){
  const db=await loadExamples(); if(!db||!Object.keys(db).length) return [];
  const k=normKey(text); if(db[k]) return db[k];
  let cands=[]; for(const key of Object.keys(db)){ if(key.includes(k) || k.includes(key)){ cands=cands.concat(db[key]); } }
  const seen=new Set(), out=[]; for(const ex of cands){ const sig=`${ex.de}||${ex.en}`; if(!seen.has(sig)){ seen.add(sig); out.push(ex); } if(out.length>=3) break; }
  return out;
}
let exDrawerEl=null; function closeExamples(){ if(exDrawerEl){ exDrawerEl.remove(); exDrawerEl=null; } }
async function showExamples(){
  closeExamples(); const cur=current(); if(!cur) return; const anchor=cur.pair.de; const results=await findExamplesFor(anchor);
  exDrawerEl=document.createElement('div'); exDrawerEl.className='exDrawer';
  exDrawerEl.innerHTML = (results.length? results.slice(0,3).map(ex=>`
    <div class="exItem"><div><strong>${ex.de}</strong></div><div>${ex.en}</div><div class="src">${ex.src||'Example'}</div></div>
  `).join('') : `<div class="exItem"><em>No examples yet for “${anchor}”.</em><br><span class="src">Add them to <code>data/examples.json</code>.</span></div>`);
  exDrawerEl.addEventListener('click', e=>e.stopPropagation());
  document.body.appendChild(exDrawerEl); document.addEventListener('click', closeExamples, {once:true});
}
document.getElementById('examplesBtn').onclick=(e)=>{e.stopPropagation();showExamples()}

/* ===== daily goal & boot ===== */
dailyGoalInput.onchange=(e)=>{const v=Math.max(5,Math.min(200,parseInt(e.target.value||30))); stats.dailyGoal=v; saveStats(); updateHeader(); }
function applyStartGestures(){ cardEl.addEventListener('click',()=>{ if(modeSel.value==="mc"||modeSel.value==="time") return; flip(); }); }
function boot(){
  applyTheme(); loadVoices(); tickDaily(); saveStats(); updateHeader(); refreshTagSelect();
  buildRound({shuffleQ:true}); applyStartGestures();
}
boot();
</script>

<!-- ====== APPENDED: preload your 331-word dataset (no existing lines changed) ====== -->
<script>
(function(){
  const PRELOAD_FLAG = 'german_flashcards_preloaded_331_v1';
  if (localStorage.getItem(PRELOAD_FLAG)) return; // only once per browser

  // Parse "N. de – en #tag" lines
  const raw = `
1. Eben – just now #time
2. gelten – to be valid #verb
3. halt – simply #particle
4. allerdings – indeed #adverb
5. überhaupt – generally #adverb
6. entsprechen – to correspond #verb
7. einzeln – individual #adjective
8. sogar – even or in fact #adverb
9. entstehen – to develop or originate #verb
10. sonst – otherwise #conjunction
11. eher – more likely or rather #adverb
12. darstellen – to portray or depict #verb
13. dessen – whose #pronoun
14. erscheinen – to appear #verb
15. gewiss – certain or sure #adjective
16. vergehen – to pass time #verb
17. wesentlich – essential or fundamental #adjective
18. anbieten – to offer #verb
19. ebenso – just as or equally #adverb
20. Abbildung – illustration #noun
21. Jahrhundert – century #time
22. verlassen – to leave #verb
23. ausgehen – to go out or assume #verb
24. geschehen – to happen or occur #verb
25. annehmen – to accept or assume #verb
26. bezeichnen – to name or label #verb
27. befinden – to be or to feel #verb
28. ebenfalls – also #adverb
29. aufnehmen – to record or include #verb
30. bestimmen – to decide or determine #verb
31. treten – to step #verb
32. erfolgen – to occur or take place #verb
33. bloß – simply or just #particle
34. betrachten – to look at or consider #verb
35. gelingen – to succeed #verb
36. jeweils – each time #adverb
37. Lage – situation or location #noun
38. Leistung – performance #noun
39. zumindest – at least #adverb
40. leisten – to achieve or accomplish #verb
41. verlangen – to demand or request #verb
42. Einsatz – deployment or effort #noun
43. Gebiet – region or area #noun
44. vorliegen – to exist or be present #verb
45. Dorf – village #place
46. Verfügung – disposal #noun
47. zur Verfügung stehen – to be available #expression
48. zur Verfügung stellen – to provide #expression
49. stecken – to be located or stick #verb
50. Anspruch – claim or right #noun
51. beziehen – to refer or obtain #verb
52. spüren – to sense or feel #verb
53. vorhanden – available or existing #adjective
54. hinaus – in addition or beyond #adverb
55. künftig – future or forthcoming #adjective
56. vorkommen – to happen or occur #verb
57. betonen – to emphasize or stress #verb
58. erfüllen – to fulfill or grant #verb
59. knapp – scarce or barely #adjective
60. lieber – rather or preferably #adverb
61. zugleich – at the same time #adverb
62. Reihe – row or line or series #noun
63. beteiligen – to participate #verb
64. indem – while or by doing #conjunction
65. sich eignen – to be suitable #verb
66. übrig – remaining or left #adjective
67. durchaus – absolutely #adverb
68. Macht – power or strength #noun
69. eingehen – to deal with or engage #verb
70. schweigen – to remain silent #verb
71. das Schweigen – silence #noun
72. drohen – to threaten #verb
73. ehemalig – former #adjective
74. längst – long since or already #adverb
75. stets – always #adverb
76. jeweilig – respective #adjective
77. Beitrag – contribution #noun
78. erforderlich – necessary or required #adjective
79. heutig – today’s or present #adjective
80. lediglich – merely or only #adverb
81. unmittelbar – immediate or direct #adjective
82. Aussage – statement #noun
83. immerhin – after all or anyway #adverb
84. betreiben – to operate or pursue #verb
85. stoßen – to push or bump #verb
86. vertreten – to represent #verb
87. Ansatz – approach or attempt #noun
88. stammen – to originate or come from #verb
89. verhindern – to prevent #verb
90. Hälfte – half #noun
91. überlegen – to consider or reflect #verb
92. der Gegenstand – object or item #noun
93. üblich – usual or common #adjective
94. verzichten – to do without #verb
95. aufgeben – to give up or quit #verb
96. Auftrag – order or assignment #noun
97. betragen – to amount to #verb
98. Freude – joy #emotion
99. gesellschaftlich – social #adjective
100. angeben – to claim or declare or show off #verb
101. einrichten – to set up or furnish #verb
102. Forschung – research #noun
103. geraten – to get into #verb
104. rasch – quick or rapid #adjective
105. vielmehr – rather or instead #adverb
106. erheblich – considerable or significant #adjective
107. vermitteln – to arrange or mediate #verb
108. Angriff – attack #noun
109. gründen – to found or establish #verb
110. herrschen – to rule or prevail #verb
111. schieben – to push #verb
112. behaupten – to claim or assert #verb
113. Beschäftigte – employee #noun
114. erheben – to raise or lift #verb
115. verfolgen – to pursue or track #verb
116. zwingen – to force #verb
117. ablehnen – to refuse or reject #verb
118. Anschlag – attack or assault #noun
119. auftauchen – to surface or appear #verb
120. einfallen – to collapse or to occur #verb
121. Einrichtung – institution or furnishing #noun
122. fördern – to promote or support #verb
123. Vorsitzende – chairperson #noun
124. ansprechen – to address or speak to #verb
125. beachten – to pay attention #verb
126. Spur – track or lane or trace #noun
127. wenden – to turn #verb
128. angesichts – in view of #preposition
129. Erkenntnis – realization or insight #noun
130. fassen – to grasp or hold #verb
131. leise – soft or quiet #adjective
132. nicken – to nod #verb
133. prägen – to shape or characterize #verb
134. anschließend – subsequently or afterwards #adverb
135. Ereignis – event #noun
136. Opfer – victim or sacrifice #noun
137. vorsehen – to plan or provide for #verb
138. Aufnahme – recording or reception or snapshot #noun
139. begreifen – to understand or grasp #verb
140. eröffnen – to open or start #verb
141. Jahrzehnt – decade #time
142. anlegen – to invest or put on #verb
143. Einstellung – attitude or employment #noun
144. Gericht – court or dish #noun
145. der Sieg – victory #noun
146. Tat – deed or act #noun
147. Bund – association or federation #noun
148. insofern – as far as or in that respect #conjunction
149. Rand – edge or border #noun
150. anschauen – to look at or watch #verb
151. hingegen – on the other hand #conjunction
152. Verlust – loss #noun
153. verteilen – to distribute #verb
154. vornehmen – to plan or undertake #verb
155. Zuschauer – spectator #noun
156. abgeben – to hand in or submit #verb
157. aufweisen – to show or exhibit #verb
158. Vertreter – representative #noun
159. weitgehend – extensive or largely #adjective
160. derjenige – the one #pronoun
161. Eigenschaft – quality or characteristic #noun
162. erzielen – to achieve or obtain #verb
163. nachher – afterwards or later #adverb
164. durchsetzen – to enforce or carry through #verb
165. ersetzen – to replace #verb
166. heftig – violent or intense #adjective
167. Anlage – facility or complex or investment #noun
168. Bühne – stage #noun
169. drängen – to push or urge #verb
170. eindeutig – clear or unambiguous #adjective
171. ausmachen – to agree on or to switch off #verb
172. berühmt – famous #adjective
173. erfassen – to grasp or record #verb
174. gestalten – to shape or design #verb
175. Ansicht – opinion or view #noun
176. anziehen – to attract or put on #verb
177. auseinander – apart #adverb
178. scheitern – to fail or break down #verb
179. Ton – tone or sound or clay #noun
180. Veranstaltung – event #noun
181. angehen – to concern or to approach #verb
182. Ausnahme – exception #noun
183. einführen – to introduce or import #verb
184. Mehrheit – majority #noun
185. gelangen – to reach #verb
186. Mauer – wall #noun
187. reißen – to tear #verb
188. riesig – enormous #adjective
189. verweisen – to refer or expel #verb
190. dicht – dense or thick #adjective
191. erweisen – to prove or show #verb
192. fürchten – to fear #verb
193. Gestalt – figure or shape #noun
194. Stellung – position or stance #noun
195. Zugang – access #noun
196. aufstellen – to set up or establish #verb
197. ermitteln – to investigate or determine #verb
198. gegenwärtig – current or present #adjective
199. Vorgang – process or occurrence #noun
200. zerstören – to destroy #verb
201. ablaufen – to expire or run out #verb
202. ergänzen – to add or complete #verb
203. Gewalt – violence #noun
204. Konzern – corporation or group #noun
205. Lager – camp or storeroom #noun
206. Lehre – apprenticeship or lesson or doctrine #noun
207. Schatten – shadow or shade #noun
208. Strecke – distance or route #noun
209. Szene – scene #noun
210. anschließen – to connect or join #verb
211. entlang – along #preposition
212. gemäß – in accordance with #preposition
213. schießen – to shoot #verb
214. streichen – to paint or cancel #verb
215. Tor – goal or gate #noun
216. Aktie – stock or share #noun
217. Anlass – occasion or cause #noun
218. Ausgabe – edition or expense or distribution #noun
219. behalten – to keep #verb
220. belegen – to prove or cover or register #verb
221. Führung – management or leadership #noun
222. stürzen – to fall or tumble #verb
223. umgehen – to handle or deal with #verb
224. zukommen – to come towards or be in store #verb
225. absehen – to foresee or predict #verb
226. Anforderung – requirement or demand #noun
227. beweisen – to prove #verb
228. ohnehin – anyway #adverb
229. Vorschrift – regulation or rule #noun
230. äußerst – extremely #adverb
231. ausüben – to practice or exercise #verb
232. betreten – to enter or step into #verb
233. einst – once or formerly #adverb
234. erzeugen – to produce or generate #verb
235. künstlerisch – artistic #adjective
236. Urteil – sentence or judgment #noun
237. verbergen – to hide #verb
238. begegnen – to meet or come across #verb
239. erschrecken – to frighten or startle #verb
240. sämtlich – all or altogether #adjective
241. schütteln – to shake #verb
242. umgekehrt – reverse or opposite #adjective
243. zurückziehen – to withdraw #verb
244. erleichtern – to make easier or relieve #verb
245. Haltung – posture or attitude #noun
246. mächtig – powerful #adjective
247. Waffe – weapon #noun
248. angeblich – alleged or supposedly #adverb
249. anhand – on the basis of #preposition
250. Einführung – introduction #noun
251. Loch – hole #noun
252. nachweisen – to prove or verify #verb
253. Quelle – source #noun
254. Umsatz – turnover or sales #noun
255. Vorwurf – accusation or reproach #noun
256. bedienen – to serve or operate #verb
257. beherrschen – to master or control #verb
258. bunt – colorful #adjective
259. leuchten – to shine #verb
260. Merkmal – feature or characteristic #noun
261. mittels – by means of #preposition
262. mitten – in the middle #adverb
263. überwiegend – predominant or mostly #adjective
264. verabschieden – to say goodbye or adopt #verb
265. verbieten – to prohibit or forbid #verb
266. vorlegen – to present or provide #verb
267. ausrichten – to align or adjust #verb
268. bedingen – to cause or require #verb
269. Bestimmung – regulation or purpose #noun
270. Botschaft – message or embassy #noun
271. drüben – over there #adverb
272. Fortschritt – progress #noun
273. Nachfrage – demand or request #noun
274. Pflicht – duty or obligation #noun
275. starren – to stare #verb
276. Wille – will #noun
277. anhalten – to stop #verb
278. erläutern – to explain #verb
279. Gegner – enemy or opponent #noun
280. Hinsicht – respect or regard #noun
281. unternehmen – to undertake or do #verb
282. verraten – to betray or reveal #verb
283. Welle – wave #noun
284. zeichnen – to draw #verb
285. anstreben – to aim at or strive for #verb
286. ausführen – to carry out or execute #verb
287. Betrag – amount or sum #noun
288. derartig – such or like that #adjective
289. hingehen – to go there #verb
290. Schicht – layer or shift #noun
291. schmal – narrow or slender #adjective
292. Verhandlung – negotiation #noun
293. begeistern – to inspire or excite #verb
294. Gewerkschaft – trade union #noun
295. Handel – trade #noun
296. Kanzler – chancellor #noun
297. Sitz – seat or headquarters #noun
298. steuern – to steer or control #verb
299. umsetzen – to implement or put into practice #verb
300. unheimlich – scary or eerie #adjective
301. wagen – to risk or dare #verb
302. Widerstand – resistance or opposition #noun
303. anzeigen – to report or indicate #verb
304. auffordern – to request or urge #verb
305. eintragen – to enter or register or record #verb
306. entsprechend – in accordance with #adjective
307. enttäuschen – to disappoint #verb
308. gewaltig – enormous or tremendous #adjective
309. Schriftsteller – writer or author #noun
310. Überlegung – thought or consideration #noun
311. veröffentlichen – to publish #verb
312. voraussetzen – to assume or take for granted #verb
313. zugeben – to admit or confess #verb
314. Abgeordnete – member of parliament #noun
315. Anschluss – connection or link #noun
316. ansetzen – to position or schedule or estimate #verb
317. befürchten – to fear #verb
318. Boot – boat #noun
319. Einnahme – income or revenue #noun
320. Saison – season #noun
321. zumal – particularly or especially #adverb
322. Auftritt – appearance or entrance or performance #noun
323. bevorzugen – to prefer #verb
324. kennzeichnen – to mark or characterize #verb
325. Schicksal – fate or destiny #noun
326. sofern – provided that #conjunction
327. Verlag – publishing company #noun
328. zitieren – to quote #verb
329. Beweis – proof or evidence #noun
330. Forscher – researcher #noun
331. erledigen – to take care of or settle #verb
`.trim();

  function parseList(text){
    const lines = text.split(/\r?\n/);
    const out = [];
    for (const line of lines) {
      const stripped = line.replace(/^\s*\d+\.\s*/, '');
      const parts = stripped.split(/\s+–\s+/); // en dash
      if (parts.length < 2) continue;
      const de = parts[0].trim();
      const right = parts[1].trim();
      const tags = Array.from(stripped.matchAll(/#([\p{L}\p{N}_-]+)/gu)).map(m => m[1]);
      const en = right.replace(/\s*#.*$/,'').trim();
      if (!de || !en) continue;
      out.push({ de, en, box:1, dueAt:0, tags });
    }
    return out;
  }

  try {
    const pairs = parseList(raw);

    // Use app's own merger if available; otherwise do a local one
    const added = (typeof mergeIntoDeck === 'function')
      ? mergeIntoDeck(pairs)
      : (function fallbackMerge(pairs){
          const LS_KEY="german_flashcards_deck_v2";
          const existing = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
          const sig = p => `${p.de}||${p.en}`.toLowerCase().trim();
          const seen = new Set(existing.map(sig));
          const toAdd = [];
          for (const p of pairs) if (!seen.has(sig(p))) { toAdd.push(p); seen.add(sig(p)); }
          const next = existing.concat(toAdd);
          localStorage.setItem(LS_KEY, JSON.stringify(next));
          return toAdd.length;
        })(pairs);

    if (added > 0) {
      try { localStorage.setItem(PRELOAD_FLAG, 'yes'); } catch(e){}
      if (typeof buildRound === 'function') { buildRound({ shuffleQ:true }); }
    } else {
      try { localStorage.setItem(PRELOAD_FLAG, 'yes'); } catch(e){}
    }
  } catch (e) {
    // silent fail to avoid breaking any feature
    console.error('Preload failed:', e);
  }
})();
</script>
</body>
</html>
